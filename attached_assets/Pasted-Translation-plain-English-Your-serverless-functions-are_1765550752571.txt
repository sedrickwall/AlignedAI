Translation (plain English)

Your serverless functions are importing a file that does not exist in the deployed bundle.

Because of that:

âŒ Firebase Admin never initializes

âŒ getAuth().verifyIdToken() throws

âŒ Every API route returns 500

âŒ Home dashboard can never load

âŒ Onboarding completion redirect appears â€œbrokenâ€ but isnâ€™t

ğŸ”´ WHY THIS IS HAPPENING

Your API files contain imports like:

import { initAdmin } from "../utils/initAdmin";


But on Vercel, the runtime expects:

/api/utils/initAdmin.js

One of these is true (usually #1 or #2):

api/utils/initAdmin.ts does not exist

File exists locally but is not committed to Git

Folder name casing mismatch (Utils vs utils)

Relative path is wrong (../utils vs ./utils)

Vercel is compiling to ESM and cannot resolve extensionless imports

The error path proves it:

/var/task/api/utils/initAdmin   âŒ NOT FOUND

âœ… THE FIX (DO THIS EXACTLY)
âœ… 1. Correct file location (required)

Your repo must contain this exact file:

/api/utils/initAdmin.ts


NOT:

/utils/initAdmin.ts

/server/utils/initAdmin.ts

/api/initAdmin.ts

âœ… Correct structure:

api/
  utils/
    initAdmin.ts
  daily.ts
  weekly.ts
  reflections.ts
  ai/
    prioritize.ts

âœ… 2. Fix imports in ALL API files

Replace every admin import with this:

import { initAdmin } from "./utils/initAdmin";


âŒ Do NOT use:

../utils/initAdmin
../../utils/initAdmin


Because Vercel resolves from /api/* root.

âœ… 3. Make initAdmin.ts ESM-safe (important)

Use this exact version:

// api/utils/initAdmin.ts
import * as admin from "firebase-admin";

export function initAdmin() {
  if (admin.apps.length) return;

  const key = process.env.FIREBASE_ADMIN_KEY;
  if (!key) {
    throw new Error("FIREBASE_ADMIN_KEY is missing");
  }

  let serviceAccount: any;

  if (key.trim().startsWith("{")) {
    serviceAccount = JSON.parse(key);
  } else {
    const decoded = Buffer.from(key, "base64").toString("utf-8");
    serviceAccount = JSON.parse(decoded);
  }

  if (serviceAccount.private_key) {
    serviceAccount.private_key =
      serviceAccount.private_key.replace(/\\n/g, "\n");
  }

  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
  });
}

âœ… 4. Redeploy (not restart)
git add .
git commit -m "Fix initAdmin import path"
git push


Then wait for a full Vercel redeploy.

ğŸ§  Why ALL endpoints failed (important insight)

You noticed:

/api/ai/prioritize doesnâ€™t hit Firestore but still fails

Thatâ€™s because the import fails before runtime:

import { initAdmin } from "./utils/initAdmin"; // ğŸ’¥ module not found


The function crashes before this line ever runs:

await getAuth().verifyIdToken(token);


So Firebase Auth was never the real issue â€” the module load failed.

ğŸš« Firestore Rules Are NOT the Issue

Your rules are fine for client SDK usage.

They do not apply to:

Firebase Admin SDK

Serverless functions

Vercel APIs

Admin SDK bypasses rules entirely.

âœ… What will happen after the fix

Once initAdmin resolves correctly:

âœ… /api/ai/prioritize returns JSON

âœ… /api/daily loads

âœ… /api/weekly loads

âœ… /api/reflections loads

âœ… Home dashboard renders

âœ… Onboarding completion redirect works

ğŸ” Quick sanity check after deploy

Hit this URL in browser (with auth token):

/api/ai/prioritize


If you get:

{
  "suggestion": "...",
  "reasoning": "...",
  "focusPillar": "Faith"
}


You are officially unblocked.